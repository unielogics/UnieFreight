# UnieFreight – Amplify build spec (Next.js SSR)
#
# REQUIRED in Amplify Console to avoid 404 on /dashboard/ and all routes:
# 1. Hosting → Framework: set to "Next.js - SSR" (or "Next.js") so Amplify runs the Node server.
# 2. If this repo is the full UnieWMS monorepo: General → Build settings → Root directory = "UnieFreight"
#    so the build runs from this folder (npm ci / npm run build use this app's package.json).
# 3. Environment variables: NEXT_PUBLIC_API_BASE_URL (e.g. https://api.uniewms.com/api/v1)
#
# This app is NOT a static export; dynamic routes like /dashboard/opportunities/[id] require SSR.
version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "Build root: $(pwd)"
        - |
          if [ ! -f package.json ]; then
            echo "ERROR - No package.json in build root. Set Root directory to UnieFreight in Amplify."
            exit 1
          fi
          echo "package.json name: $(node -p "require('./package.json').name")"
        - npm ci --cache .npm --prefer-offline
        - echo "PreBuild complete"
    build:
      commands:
        - echo "Starting Next.js build (SSR)..."
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - "**/*"
  cache:
    paths:
      - .next/cache/**/*
      - node_modules/**/*
      - .npm/**/*
  environment:
    variables:
      NODE_OPTIONS: --max-old-space-size=4096
      NODE_ENV: production
      CI: "true"
